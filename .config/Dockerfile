FROM node:22
WORKDIR /radar

ARG DOMAIN
ARG NAVIGRAPH_CLIENT_ID
ARG NAVIGRAPH_CLIENT_SECRET
ARG NAVIGRAPH_SERVER_ID
ARG NAVIGRAPH_SERVER_SECRET
ARG VATSIM_CLIENT_ID
ARG VATSIM_CLIENT_SECRET
ARG VATSIM_ENDPOINT
ARG DATABASE_URL

ARG DISCORD_CLIENT_ID
ARG DISCORD_TOKEN
ARG DISCORD_SERVER_ID
ARG DISCORD_INTERNAL_SERVER_ID
ARG DISCORD_RELEASES_CHANNEL_ID
ARG DISCORD_ROLE_ID
ARG ACCESS_BY_DISCORD_ROLES
ARG IS_DOWN

ARG INFLUX_URL
ARG INFLUX_TOKEN
ARG INFLUX_ORG
ARG INFLUX_BUCKET_MAIN
ARG INFLUX_BUCKET_ONLINE
ARG INFLUX_ENABLE_WRITE
ARG INFLUX_BUCKET_PLANS
ARG DISABLE_WEBSOCKETS

ARG VATSIM_KAFKA_BROKER
ARG VATSIM_KAFKA_USER
ARG VATSIM_KAFKA_PASSWORD
ARG VATSIM_KAFKA_GROUP

ARG CF_R2_API
ARG CF_R2_ACCESS_ID
ARG CF_R2_ACCESS_TOKEN

ARG FAA_NOTAMS_CLIENT_ID
ARG FAA_NOTAMS_CLIENT_SECRET

ARG PATREON_ACCESS_TOKEN

ENV NUXT_DOMAIN=${DOMAIN}
ENV NUXT_NAVIGRAPH_CLIENT_ID=${NAVIGRAPH_CLIENT_ID}
ENV NUXT_NAVIGRAPH_CLIENT_SECRET=${NAVIGRAPH_CLIENT_SECRET}
ENV NUXT_NAVIGRAPH_SERVER_ID=${NAVIGRAPH_SERVER_ID}
ENV NUXT_NAVIGRAPH_SERVER_SECRET=${NAVIGRAPH_SERVER_SECRET}
ENV NUXT_VATSIM_CLIENT_ID=${VATSIM_CLIENT_ID}
ENV NUXT_VATSIM_CLIENT_SECRET=${VATSIM_CLIENT_SECRET}
ENV NUXT_VATSIM_ENDPOINT=${VATSIM_ENDPOINT}
ENV NUXT_DATABASE_URL=${DATABASE_URL}
ENV DATABASE_URL=${DATABASE_URL}
ENV NUXT_DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
ENV NUXT_DISCORD_TOKEN=${DISCORD_TOKEN}
ENV NUXT_DISCORD_SERVER_ID=${DISCORD_SERVER_ID}
ENV NUXT_DISCORD_INTERNAL_SERVER_ID=${DISCORD_INTERNAL_SERVER_ID}
ENV NUXT_DISCORD_RELEASES_CHANNEL_ID=${DISCORD_RELEASES_CHANNEL_ID}
ENV NUXT_DISCORD_ROLE_ID=${DISCORD_ROLE_ID}
ENV NUXT_ACCESS_BY_DISCORD_ROLES=${ACCESS_BY_DISCORD_ROLES}
ENV NUXT_IS_DOWN=${IS_DOWN}
ENV NUXT_INFLUX_URL=${INFLUX_URL}
ENV NUXT_INFLUX_TOKEN=${INFLUX_TOKEN}
ENV NUXT_INFLUX_ORG=${INFLUX_ORG}
ENV NUXT_INFLUX_BUCKET_MAIN=${INFLUX_BUCKET_MAIN}
ENV NUXT_INFLUX_BUCKET_ONLINE=${INFLUX_BUCKET_ONLINE}
ENV NUXT_INFLUX_ENABLE_WRITE=${INFLUX_ENABLE_WRITE}
ENV NUXT_INFLUX_BUCKET_PLANS=${INFLUX_BUCKET_PLANS}
ENV NUXT_VATSIM_KAFKA_BROKER=${VATSIM_KAFKA_BROKER}
ENV NUXT_VATSIM_KAFKA_USER=${VATSIM_KAFKA_USER}
ENV NUXT_VATSIM_KAFKA_PASSWORD=${VATSIM_KAFKA_PASSWORD}
ENV NUXT_VATSIM_KAFKA_GROUP=${VATSIM_KAFKA_GROUP}
ENV NUXT_PUBLIC_DISABLE_WEBSOCKETS=${DISABLE_WEBSOCKETS}
ENV CF_R2_API=${CF_R2_API}
ENV CF_R2_ACCESS_ID=${CF_R2_ACCESS_ID}
ENV CF_R2_ACCESS_TOKEN=${CF_R2_ACCESS_TOKEN}
ENV PATREON_ACCESS_TOKEN=${PATREON_ACCESS_TOKEN}
ENV FAA_NOTAMS_CLIENT_ID=${FAA_NOTAMS_CLIENT_ID}
ENV FAA_NOTAMS_CLIENT_SECRET=${FAA_NOTAMS_CLIENT_SECRET}

ENV INFLUX_URL=${INFLUX_URL}
ENV INFLUX_TOKEN=${INFLUX_TOKEN}
ENV INFLUX_ORG=${INFLUX_ORG}
ENV INFLUX_BUCKET_MAIN=${INFLUX_BUCKET_MAIN}
ENV INFLUX_BUCKET_PLANS=${INFLUX_BUCKET_PLANS}
ENV INFLUX_ENABLE_WRITE=${INFLUX_ENABLE_WRITE}
ENV DISABLE_WEBSOCKETS=${DISABLE_WEBSOCKETS}
ENV VATSIM_KAFKA_BROKER=${VATSIM_KAFKA_BROKER}
ENV VATSIM_KAFKA_USER=${VATSIM_KAFKA_USER}
ENV VATSIM_KAFKA_PASSWORD=${VATSIM_KAFKA_PASSWORD}
ENV VATSIM_KAFKA_GROUP=${VATSIM_KAFKA_GROUP}
ENV NAVIGRAPH_CLIENT_ID=${NAVIGRAPH_CLIENT_ID}
ENV NAVIGRAPH_CLIENT_SECRET=${NAVIGRAPH_CLIENT_SECRET}
ENV NAVIGRAPH_SERVER_ID=${NAVIGRAPH_SERVER_ID}
ENV NAVIGRAPH_SERVER_SECRET=${NAVIGRAPH_SERVER_SECRET}
ENV NODE_ENV=production

COPY package.json package.json
COPY yarn.lock yarn.lock
COPY .yarn /radar/.yarn/
COPY .yarnrc.yml .yarnrc.yml

RUN apt-get update
RUN apt-get install -y default-mysql-client

RUN yarn

COPY . /radar
RUN npx prisma generate
RUN yarn build

EXPOSE 3000
CMD ["sh", "-c", "npx prisma migrate deploy && node /radar/.output/server/index.mjs"]
