FROM node:20.12.2
WORKDIR /radar

ARG DOMAIN
ARG NAVIGRAPH_CLIENT_ID
ARG NAVIGRAPH_CLIENT_SECRET
ARG NAVIGRAPH_SERVER_ID
ARG NAVIGRAPH_SERVER_SECRET
ARG VATSIM_CLIENT_ID
ARG VATSIM_CLIENT_SECRET
ARG VATSIM_ENDPOINT
ARG DATABASE_URL
ARG DISCORD_CLIEND_ID
ARG DISCORD_TOKEN
ARG DISCORD_SERVER_ID
ARG DISCORD_RELEASES_CHANNEL_ID
ARG DISCORD_ROLE_ID
ARG IS_DOWN

ENV NUXT_DOMAIN=${DOMAIN}
ENV NUXT_NAVIGRAPH_CLIENT_ID=${NAVIGRAPH_CLIENT_ID}
ENV NUXT_NAVIGRAPH_CLIENT_SECRET=${NAVIGRAPH_CLIENT_SECRET}
ENV NUXT_NAVIGRAPH_SERVER_ID=${NAVIGRAPH_SERVER_ID}
ENV NUXT_NAVIGRAPH_SERVER_SECRET=${NAVIGRAPH_SERVER_SECRET}
ENV NUXT_VATSIM_CLIENT_ID=${VATSIM_CLIENT_ID}
ENV NUXT_VATSIM_CLIENT_SECRET=${VATSIM_CLIENT_SECRET}
ENV NUXT_VATSIM_ENDPOINT=${VATSIM_ENDPOINT}
ENV NUXT_DATABASE_URL=${DATABASE_URL}
ENV DATABASE_URL=${DATABASE_URL}
ENV NUXT_DISCORD_CLIEND_ID=${DISCORD_CLIEND_ID}
ENV NUXT_DISCORD_TOKEN=${DISCORD_TOKEN}
ENV NUXT_DISCORD_SERVER_ID=${DISCORD_SERVER_ID}
ENV NUXT_DISCORD_RELEASES_CHANNEL_ID=${DISCORD_RELEASES_CHANNEL_ID}
ENV NUXT_DISCORD_ROLE_ID=${DISCORD_ROLE_ID}
ENV NUXT_IS_DOWN=${IS_DOWN}

COPY package.json package.json
COPY yarn.lock yarn.lock
COPY .yarn /radar/.yarn/
COPY .yarnrc.yml .yarnrc.yml

RUN yarn

COPY . /radar
RUN npx prisma generate
RUN yarn build

EXPOSE 3000
CMD ["sh", "-c", "npx prisma migrate deploy && node /radar/.output/server/index.mjs"]
